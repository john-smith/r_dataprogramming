# Chapter6
## 仮説検定(Hypothesis Test)とは
1. 仮説の設定
 * 帰無仮説H0  
 否定したい仮説。2グループで変化が無いなど
 * 対立仮説H1  
 採用されてほしい仮説。95%信頼区間で有意など
2. 有意水準の設定と統計検定量算出
 * 統計検定量：標準正規分布のz値やt分布のt値など分布に基づいて計算される値  
 有意水準：帰無仮説を棄却するための確率値。  
 観測された統計検定量となる確率がこの水準以下の確率である場合は偶然では説明できな現象が観測されたとする。  
 一般的には5%や1%が利用される
3. 仮説の保留 or 棄却
 * 統計検定量が有意水準を超えるかを判定
 有意水準を超える場合は帰無仮説が間違いだったと判断する  
 超えない場合は帰無仮説がただしい可能性を否定できないと**対立仮説を棄却するのではなく保留する**
 
標準正規分布の95%信頼区間での有意水準  
$-1.96 < z < 1.96$の範囲に収まらない場合は**両端合わせて**5%以下(正規分布は左右対称)

* 第1種の過誤
 * 帰無仮説が正しいのに棄却してしまう
 有意水準を偶然超えた
* 第2種の過誤
 * 対立仮説が正しいのに保留してしまう
 有意水準は超えなかったが、実は対立仮説があっていた
 
## 1標本の平均値の検定
標本平均が母集団の平均と同一かを検定する

t値：平均値から求める値(x軸)  
p値：求めたt値が自由度$N-1$のt分布において起こる確率(y軸)  

t値を求める
\[
  t = \frac{\bar X - \mu}{stderr} \\
  = \frac{\bar X - \mu}{\frac{\sigma}{\sqrt{N}}}
  
\]
```{r}
#自由度29でp値が0.975となるt値
(t.value <- qt(0.975, 30 - 1))

# p値の範囲となる実際の値を取得
c(mean(x - t.value * sd(x) / sqrt(30)), mean(x + t.value * sd(x) / sqrt(30)))
```

t検定を行う 
```{r}
 x <- c (178.59,181.14,177.6,180.55,178.54,179.32,
       180.01,179.44,180.65,181.55,179.2,180.56,
       179.9,178.81,179.64,179.63,179.36,178.85,
       179.82,182.43,180.47,179.66,181.54,178.98,
       180.2,179.87,179.05,179.72,179.34,180.26)

#母平均180に対してのt検定
t.test(x, mu = 180)
```
今回の場合, $\pm 0.9591$から外れる左右の面積の合計が$0.17 * 2 = 0.34$となり  
0.05(5%)や0.01(1%)以下とはならないため帰無仮説(差がない)が保留される

## 2標本の平均値の検定
標本と母集団が比較対象ではなく、2つの標本で比較する
* H0：標本Aと標本Bには差がない
* H1：標本Aと標本Bには差がある(両側検定)  
 標本Aは標本Bより高いor低い(片側検定)

2標本の検定では**等分散性の検定**の結果によって検定手法がかわる

ウェルチの検定(分散が等しくない場合)
```{r}
A <- c (45,45,46,42,47,45,44,47,43,44,44,47,45,48,44,
        43,48,49,44,47,47,47,48,45,45,45,44,50,44,46)
B <- c (48,50,50,46,48,48,46,49,47,48,50,45,46,49,50,
        51,46,47,47,46,49,47,47,50,48,48,49,47,49,47)

#2標本でt検定
#Welch Two Sample t-testが行われている
#等分散性を仮定するならvar.equal=Tとする
t.test(A, B)
```
※自由度をちゃんと確認しておくこと

片側検定  
片側検定ではどちらか片方だけで有意水準を判定するので、  
両側では5%の時片方につき2.5%だったのが、片方だけ5%となるため有意になりやすい  
どちらを使うかは慎重に！
```{r}
#Aの平均:45.6, Bの平均:47.9なので、
#H1:AはBより低いで片側検定

#alternative="less"で平均値の差がマイナスになるかを検定
#gleaterで逆側が検定できる
#defaultはtow.side(両側)
t.test(A, B, alternative="less") 
```

## 対応のある2標本の検定
実験前、後など測定対象が同一である場合に使用する  
前と後で同一のデータには同じ傾向があるのでデータには相関がある
```{r}
weight <- read.csv("data/weight.csv")
mean(weight$before)
mean(weight$after)

#paired=Tで対応があるデータの検定
#t.test(after ~ before, paired=T, data=weight) #なぜかうまくいかなかった
t.test(weight$before, weight$after, paired=T)
```

## csv書き込み
```{r}
x <- c("スミス", "ジョースター", "ジャクソン", "初音", "高橋")
y <- c(100, 90, 70, 120, 10)
xy <- data.frame(Name = x, Score= y)
xy
#idをつける
xy$ID <- paste("student", 1:5, sep="-")
xy
names(xy)

xy2 <- xy[, c("ID", "Score")]
xy2

write.csv(xy2, "xy.csv")
file.show("xy.csv")

#quote = FALSE : 文字列にクオートをつけない
#row.names = FALSE : 左端に行名を出力しない
#spe : 区切り文字の指定
#fileEncodign : エンコードの指定
write.csv(xy2, file="xy.csv", quote=F, row.names=F)
file.show("xy.csv")

#読み込み
xy2 <- read.csv("xy.csv")
```

## 独立性の検定
カイ自乗検定を使う
```{r}
HairEyeColor
sum(HairEyeColor[, , "Female"])
```

### 理想的なマトリックス
Eye/Hair|Brown|Blue|Hazel|Green
--------|-----|----|-----|-----
Black   | 10  | 10 | 10  | 10
Brown   | 10  | 10 | 10  | 10
Red     | 10  | 10 | 10  | 10
Blond   | 10  | 10 | 10  | 10

値がここからずれてるときに髪の色と目の色に関連があるか  
* H0:両者は独立である
* H1:関連がある
とする

理想的な表(上のような全部同じ値となる)と実際に観測された値の差をとる  
数値の大小は確率で判断

* H0:政党支持率に男女間で差はない
* H1:差がある

理想的な表

     | 支持 | 不支持 
-----|------|--------
男性 |  20  |  20
女性 |  20  |  20 

観測された値

     | 支持 | 不支持 
-----|------|--------
男性 |  22  |  18
女性 |  18  |  22 

$実測値 - 期待値$

     | 支持 | 不支持 
-----|------|--------
男性 |   2  |  -2
女性 |  -2  |   2 

```{r}
(x <- matrix(c(22, 18, 18, 22), ncol = 2))
#X-squared : カイ自乗値
#観測地と期待値の差を表す値。この値よりも大きい値が得られる確率を求める
#correct = FALSEで2行2列の場合でもイェーツの補正をしない
(x.chi <- chisq.test(x))

#期待値
x.chi$expected

#実測値
x.chi$observed

#統計情報
x.chi$statistic
```


## カイ自乗分布
自由度によって形状が異なる分布  
自由度が大きくなるほど正規分布に近づく

$男性の割合(40 / 80 = 0.5) * 支持者の割合(40 / 80 = 0.5) = 0.25$  
$観測者数(80) * 0.25 = 期待値(20)$

カイ自乗値
\[
  \chi ^ 2 = \sum_{i} \frac{(O_i - E_i) ^ 2}{E_i}
\]
```{r}
#周辺合計を取得
addmargins(x)

#期待値からの差
#合計が0になってる
x - 20

#カイ自乗値の算出
#補正なし
sum((x - 20) ^ 2 / 20)
```

自由度の計算  
2行2列の場合だと、1つのセルの値が決まれば列合計、行合計が固定される。  
そして全合計も固定されるのでの自由度は1  
一般的には $(行数 - 1) * (列数 - 1)
```{r}
#自由度1でカイ自乗値が0.8より大きくなる確率
1 - pchisq(0.8, df = 1)
pchisq(0.8, df = 1, lower.tail = F) # 1から引かなくてよい(右裾側の面積)
```

## 確率分布の対応関数
分布                | 確率密度関数 | 累積確率密度 | 分位点
--------------------|--------------|-------------|--------
正規分布(norm)      |    dnorm     |    pnorm    | qnorm
カイ自乗分布(chisq) |    dchisq    |    pchisq   | qchisq
二項分布(binom)     |    dbinom    |    pbinom   | qbinom
t分布               |     dt       |      pt     |   qt

```{r}
dnorm(0, mean = 0, sd = 1) #平均0,分散1の正規分布の0のときの確率密度
pnorm(0, mean = 0, sd = 1) #累積
qnorm(0.5, mean = 0, sd = 1) #累積密度0.5の位置の値
```

## 対応のある独立性の検定
マクネマー検定(McNemar test)

```{r}
senkyo <- matrix(c(18, 8, 15, 21), byrow = T, ncol = 2)
addmargins(senkyo)

# 選挙前後での支持率の変化
mcnemar.test(senkyo)
```