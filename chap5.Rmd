# Chapter5
```{r eval=FALSE, echo=FALSE, include=FALSE}
#ワーキングディレクトリ設定
setwd("r_dataprogramming/")
```

## 棒グラフ
2値データを棒グラフ化
```{r}
yn <- c(y <- rep("Y", 180),  rep("N", 120)) #yes or no
table(yn)
barplot(table(yn))
```

## ヒストグラム
連続値データを扱う(とびとびは離散値)  
区間に分けて表示する
```{r}
x <- c (178.59,181.14,177.6,180.55,178.54,179.32,
       180.01,179.44,180.65,181.55,179.2,180.56,
       179.9,178.81,179.64,179.63,179.36,178.85,
       179.82,182.43,180.47,179.66,181.54,178.98,
       180.2,179.87,179.05,179.72,179.34,180.26)
hist(x)
```

## 平均値、中央値、最頻値
```{r}
x <- c (178.59,181.14,177.6,180.55,178.54,179.32,
       180.01,179.44,180.65,181.55,179.2,180.56,
       179.9,178.81,179.64,179.63,179.36,178.85,
       179.82,182.43,180.47,179.66,181.54,178.98,
       180.2,179.87,179.05,179.72,179.34,180.26)

median(x) #中央値を求める
```

平均値
\[
  \frac{1}{N} \sum_{i=1}^N X_i
\]
```{r}
mean(x)

x[1]; x[30]
sum(x) / length(x)
```

最頻値(mode)
breakは(A, B] (B, C]...
```{r}
(z <- hist(x))
z$breaks[which.max(z$count)]
z$breaks[which(z$count == max(z$count))]
```

## 分散
箱ひげ図 | 分散 |
---------|------|
四分位数 | 平均値 |
離散値  | 連続値 |

求め方
\[
  \frac{1}{N} \sum_{i=1}^N (X_i - \bar{X})^2
\]
求め方(不偏分散)
\[
  \frac{1}{N-1} \sum_{i=1}^N (X_i - \bar{X})^2
\]
```{r}
new.x <- c (183.08,179.6,176.87,180.87,179.95,177.27,
       181.62,176.83,179.45,181.3,175.5,178.22,178.41,
       185.49,180.11,180.11,178.12,180.61,177.25,182.68,
       179.37,180.44,179.61,180.37,176.93,180.82,180.04,
       180.4,181.75,174.56)
mean(new.x)

#平均は同じでもデータの中の性質は違う
boxplot(x, new.x, names = c("x", "x.new"))

var(x)
sum((x - mean(x)) ^ 2) / length(x)
```

## 標準偏差
\[
  \sqrt{\frac{1}{N-1} \sum_{i=1}^N (X_i - \bar{X})^2}
\]
分散のルートをとって元データと単位をあわせたもの

## 分布
```{r}
x <- c (178.59,181.14,177.6,180.55,178.54,179.32,
       180.01,179.44,180.65,181.55,179.2,180.56,
       179.9,178.81,179.64,179.63,179.36,178.85,
       179.82,182.43,180.47,179.66,181.54,178.98,
       180.2,179.87,179.05,179.72,179.34,180.26)
par(mfrow = c(2, 1)) #plotを2行1列にする
y <- hist(x)
boxplot(x)
y
par(mfrow = c(1, 1)) #元に戻しとく
```

## 水準ごとの分布
```{r}
summary(iris)
#mean(iris[, -5]) #エラー
colMeans(iris[, -5]) #列ごとの平均

class(iris[5])
#品種ごとの平均
#第2引数はdata frameじゃ無いとダメなので、factorとなるiris[, 5]ではだめ
aggregate(iris[, -5], iris[5], mean) 
aggregate(iris[, -5], as.data.frame(iris[, 5]), mean) #data freme化すればいける

#複数のカテゴリを利用場合はtapply関数を使う
head(CO2)
tapply(CO2$uptake, CO2[c("Type", "Treatment")], mean) 
```

## シミュレーション
```{r}
x <- c("表", "裏")
set.seed(123)
(y <- sample(x, 10, rep = T))
table(y)

z <- numeric(100)
set.seed(123)
for (i in 1:100) {
  y <- sample(x, 10, rep = T)
  z[i] <- sum(y == "表")
}
table(z)
#par(mfrow=c(1, 1))
hist(z, breaks=0:10)

library(animation)
example(flip.coin)
```

## ベルヌーイ試行
2つのうちどちらかが出る確率分布  
P(X) : Xの確率  
X : 確率変数  
\[
  P(X = 表) = P \\
  p(X = 裏) = 1 - P
\]

## 二項分布
ベルヌーイ試行をn界繰り返した時のどちらかがi回出る確率  
$p^i (1-p)^{n-i}$に組み合わせを考慮して
\[
  {}_n C_i p^i (1-p)^{n-i}
\]
で求める
```{r}
#コイントスで3回表が出る確率
#chooseはnCm
choose(10, 3) * 0.5 ^ 3 * (1 - 0.5) ^ 7

#二項分布を求める
#成功回数, 試行回数, 成功確率
dbinom(3, 10, 0.5)

#0-10回の確率分布
binom <- dbinom(0:10, 10, 0.5)
barplot(binom)
```

## 確率分布
```{r}
coin10 <- dbinom(0:10, 10, 0.5)
plot(0:10, coin10, type = "h", lwd = 5)
```
二項分布の確率密度関数 f(x)
\[
  f(x) = {}_N C_X P^X (1-p)^{N-X}
\]
N : 試行回数  
X : 成功回数

## 連続値(確率密度)
連続値の場合は特定の値をとる確率が0になる  
値ごとではなく区間単位で考える  

## 正規分布
誤差が左右均等に散らばる場合  
平均 : 規定の値  
分散 : 誤差の分布
```{r}
#実測値, 平均, 標準偏差
#実測値が観測される確率密度を返す
dnorm(181, mean = 180, sd = 1)

#実測値より左側全体の確率密度を返す
pnorm(181, mean = 180, sd = 1)

#180-181の間にある確率
pnorm(181, mean = 180, sd = 1) - pnorm(180, mean = 180, sd = 1)

#累積密度からその時の値を求める(pnormの逆)
qnorm(0.8413447, mean = 180, sd = 1)
```
正規分布の記法  
平均μ, 標準偏差σの時
\[
  X \sim N(\mu, \sigma)
\]
正規分布の確率密度関数
\[
  f(x) = \frac{1}{\sqrt{2 \pi}} \exp (- \frac{(x - \mu)^2}{2 \sigma^2})
\]

## 平均値推定
サンプリングしたデータの平均 : 標本平均  
母集団全体の平均 : 母平均  
母平均を求めるのは不可能なので、標本平均から推定する
```{r}
x <- c (178.59,181.14,177.6,180.55,178.54,179.32,
         180.01,179.44,180.65,181.55,179.2,180.56,
         179.9,178.81,179.64,179.63,179.36,178.85,
         179.82,182.43,180.47,179.66,181.54,178.98,
         180.2,179.87,179.05,179.72,179.34,180.26)
mean(x)
sd(x)
```

## 母集団と標本(視聴率の計算)
標本平均は真の平均じゃないけど関係性はある  
確率的に真の平均を求める  
※サンプリングバイアスに注意  
標準誤差を求める(一般的な計算ではないっぽい)
\[
  SE = \bar x - \pm 2 \sqrt{\frac{(\bar x (1 - \bar x))}{N}}
\]
```{r}
(0.1 - 2 * sqrt(0.1 * (1 - 0.1) / 6600)) * 100
(0.1 + 2 * sqrt(0.1 * (1 - 0.1) / 6600)) * 100
```

## 平均の分布
n回の試行を何階も繰り返すと平均値の平均や分布がとれる  
平均$\mu$, 分散$\sigma$, 標本サイズNの時、標本平均$\bar x$の分布は  
\[
  \frac{\sigma}{\sqrt{N}}
\]
平均0, 分散1に標準化すると
\[
  z = \frac{\bar x - \mu}{\frac{\sigma}{sqrt{N}}}
\]
標本誤差 : 標本平均の標準偏差
```{r}
#分散1のときの標本誤差を求める
1 / sqrt(30)
```

母集団の95%区間の確率を求める
```{r}
#平均 / 標本誤差 * 正規分布の95%信頼区間
c(179.8227 - 0.1825742 * 1.96, 179.8227 + 0.1825742 * 1.96)
```

中心極限定理 :   
* サンプリングの試行回数を増やすと平均の分布は正規分布に近づく  
* 標本平均は真の平均に近づく  
```{r}
library(animation)
example(clt.ani)
```

p-value(p値) : サンプルが母集団と一致する確率

## 標準正規分布
平均0, 分散1に形を整えたのが標準正規分布  
-1.96 ~ 1.96までが95%の区間
±1.96以下になる確率は0.025
```{r}
n <- rnorm(10000, 0, 1)
ggplot(data.frame(n), aes(n)) + geom_density()
```
\[
  -1.96 < \frac{\bar x - \mu}{\sigma / \sqrt{N}} < 1.96  \\
  -1.96 \sigma / \sqrt{N} < \bar x - \mu < 1.96 \sigma / \sqrt{N}  \\
  \bar x - 1.96 \sigma / \sqrt{N} < \mu < \bar x - 1.96 \sigma / \sqrt{N}
\]
$\bar x$から標準誤差の1.96倍を引いた値から足した値までが$\mu$の95%信頼区間  
以下再掲
```{r echo=FALSE}
#平均 / 標本誤差 * 正規分布の95%信頼区間
c(179.8227 - 0.1825742 * 1.96, 179.8227 + 0.1825742 * 1.96)
```
範囲を予測 : 区間推定  
区間推定で用いる範囲(%) : 信頼区間  
よく使われる信頼区間は95%

## 母集団の標準偏差が道の場合の推定
標本偏差を代わりに利用する  
$\mu$をsにすると正規分布ではなくなる  
自由度$N-1$のt分布を使う
\[
  t = \frac{\bar x - \mu}{s / \sqrt{N}}
\]

自由度 :   
  データ中の自由に数値を選べる数。  
  N個の平均ならばN-1個までは何を選んでもよいが残りの一個は必然的に決まる  

N-1(自由度N-1)のt分を利用する  
データの個数が少ない分裾が広くなる(ばらつきが大きくなる)  
正規分布の95%区間である1.96に対応する値は自由度によってかわる  
```{r}
N = 30
#自由度Nの95%信頼区間を求める
#左右対称なので片側なので1 - 0.025を使用している
qt(0.975, N - 1)
```
自由度29の95%信頼区間
\[
  \bar x - 2.045 \frac{s}{\sqrt{N}} < \mu < \bar x + 2.045 \frac{s}{\sqrt{N}}
\]
```{r}
#10人の平均身長が156cm, 標準偏差14cmの時のt分布で平均の95%信頼区間
N <- 10
top <- qt(0.975, N - 1)
c(156 - top * 14 / sqrt(10), 156 + top * 14 / sqrt(10)) # 正規分布より区間が広くなってる
```

## t分布のプロット
```{r}
#dt    自由度Nのt分布にデータを当てはめる
#dnorm 標準正規分布にデータを当てはめる

#曲線を各関数
curve(dt(x, 20), -4, 4, type = "l", col = 1, main = "t分布はデータ数Nで変化する", ylab = "確率")
#x, y にテキストを書く
text(1, .4, "N = 20の場合")
curve(dt(x, 10), -4, 4, type = "l", col = 2, add = T)
text(1.5, .35, "N = 10の場合")
curve(dt(x, 5), -4, 4, type = "l", col = 3, add = T)
text(1.8, .3, "N = 5の場合")
curve(dt(x, 2), -4, 4, type = "l", col = 4, add = T)
text(2.8, .17, "N = 2の場合")
curve(dnorm(x), type = "l", lty = 2, col = 6, add = T)
text(-3, .2, "正規分布", col = 6)
#凡例
legend(-4, .4, legend=c("N = 20", "N = 10", "N = 5", "N = 2", "正規分布"),
       col = c(1:4, 6), lty = c(1, 1, 1, 1, 2))
```

## 比率の区間推定
\[
  \bar P - 1.96 \sqrt{\frac{\bar P (1 - \bar P)}{N}} < 
  \mu < 
  \bar P + 1.96 \sqrt{\frac{\bar P (1 - \bar P)}{N}}
\]
$\bar P$ : 標本から求めた割合  
N : 標本数  
二項分布のNが十分に大きい時は正規分布で近似できる(正規分布と同じ信頼区間の値を利用できる)  

```{r}
#300世帯、視聴率8%の信頼区間
c(0.08 - 1.96 * sqrt(0.08 * (1 - 0.08) / 300), 
  0.08 + 1.96 * sqrt(0.08 * (1 - 0.08) / 300))
```

区間推定は真の母集団に含まれている確率なので95%の場合5%くらいは含まれていない可能性もある